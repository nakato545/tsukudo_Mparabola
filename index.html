<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ˜ã‚‹ã•å®Ÿé¨“ï¼ˆç³å­”å‹•ä½œãƒ»è‡ªç„¶ç¬ãç‰ˆï¼‰</title>
<style>
  body { margin:0; background:#f0f9ff; font-family:sans-serif; text-align:center; }
  #modeButtons { margin:10px; }
  button { padding:10px 18px; margin:5px; font-size:16px; }
  #settingsArea { display:none; padding:10px; background:#eef7ff; border-top:2px solid #ccc; }
  #brightnessDisplay { font-size:32px; font-weight:bold; color:#004477;
    text-shadow:1px 1px 3px white; pointer-events:none; margin-top:40px; display:none; }
  canvas { display:block; margin:40px auto; border-radius:6px; background:#eef; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
</style>
</head>
<body>

<div id="modeButtons">
  <button id="btnSettings">âš™ è¨­å®šãƒ¢ãƒ¼ãƒ‰</button>
  <button id="btnExperiment">ğŸ”¬ å®Ÿé¨“ãƒ¢ãƒ¼ãƒ‰</button>
  <button id="btnToggleCamera">ğŸ“· ã‚«ãƒ¡ãƒ© ON</button>
</div>

<canvas id="monsterCanvas" width="420" height="420"></canvas>
<div id="brightnessDisplay">æ˜ã‚‹ã•: --</div>

<div id="settingsArea">
  <h2>é–¾å€¤ã®è¨­å®šï¼ˆ4æ®µéšï¼‰</h2>
  æš—ã„ï¼ˆå¼±ï¼‰: <input id="t1" type="number" value="20"> luxä»¥ä¸‹<br>
  ã‚„ã‚„æš—ã„: <input id="t2" type="number" value="40"> luxä»¥ä¸‹<br>
  ã‚„ã‚„æ˜ã‚‹ã„: <input id="t3" type="number" value="80"> luxä»¥ä¸‹<br>
  æ˜ã‚‹ã„ï¼ˆæœ€å¤§ï¼‰: <input id="t4" type="number" value="200"><br><br>
  <small>â€» ã‚«ãƒ¡ãƒ©OFFæ™‚ã¯æœ€å¾Œã®æ˜ã‚‹ã•ãŒæ®‹ã‚Šã¾ã™ã€‚</small>
</div>

<script>
const canvas = document.getElementById('monsterCanvas');
const ctx = canvas.getContext('2d');
const btnSettings = document.getElementById('btnSettings');
const btnExperiment = document.getElementById('btnExperiment');
const btnToggleCamera = document.getElementById('btnToggleCamera');
const settingsArea = document.getElementById('settingsArea');
const brightnessDisplay = document.getElementById('brightnessDisplay');
const inputT1 = document.getElementById('t1');
const inputT2 = document.getElementById('t2');
const inputT3 = document.getElementById('t3');
const inputT4 = document.getElementById('t4');

let mode='settings', videoStream=null, brightness=0, brightnessLoopRunning=false;

// ç¬ããƒ»ç³å­”
let blinkState=0, blinking=false, blinkStart=0, nextBlinkAt=Date.now()+randomInterval();
let pupilOffsetX=0, pupilOffsetY=0;

function randomInterval(){ 
  const base = 4000; 
  const variance = 5000;
  const brightFactor = Math.max(0.3, 1 - brightness/200);
  return base*brightFactor + Math.random()*variance*brightFactor;
}

btnSettings.addEventListener('click', ()=>switchMode('settings'));
btnExperiment.addEventListener('click', ()=>switchMode('experiment'));
btnToggleCamera.addEventListener('click', toggleCamera);
switchMode('settings');

function switchMode(m){
  mode=m;
  if(mode==='settings'){
    settingsArea.style.display='block';
    brightnessDisplay.style.display='none';
    btnToggleCamera.textContent = videoStream?'ğŸ“· ã‚«ãƒ¡ãƒ© OFF':'ğŸ“· ã‚«ãƒ¡ãƒ© ON';
  } else {
    settingsArea.style.display='none';
    brightnessDisplay.style.display='block';
    btnToggleCamera.textContent = videoStream?'ğŸ“· ã‚«ãƒ¡ãƒ© OFF':'ğŸ“· ã‚«ãƒ¡ãƒ© ON';
  }
}

async function toggleCamera(){
  if(videoStream){
    videoStream.getTracks().forEach(t=>t.stop());
    videoStream=null;
    brightnessLoopRunning=false;
    btnToggleCamera.textContent='ğŸ“· ã‚«ãƒ¡ãƒ© ON';
    alert('ã‚«ãƒ¡ãƒ©åœæ­¢');
    return;
  }
  try{
    videoStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'} });
    btnToggleCamera.textContent='ğŸ“· ã‚«ãƒ¡ãƒ© OFF';
    startBrightnessLoop(videoStream);
    alert('ã‚«ãƒ¡ãƒ©é–‹å§‹');
  } catch(e){ alert('ã‚«ãƒ¡ãƒ©å–å¾—ä¸å¯'); console.error(e); }
}

function startBrightnessLoop(stream){
  if(!stream||brightnessLoopRunning) return;
  const video=document.createElement('video');
  video.autoplay=true; video.playsInline=true; video.muted=true; video.srcObject=stream;

  const tempCanvas=document.createElement('canvas');
  const tctx=tempCanvas.getContext('2d');
  brightnessLoopRunning=true;

  function loopFunc(){
    if(!videoStream){ brightnessLoopRunning=false; return; }
    if(video.readyState>=2){
      const w=160,h=Math.round(video.videoHeight/video.videoWidth*160)||120;
      tempCanvas.width=w; tempCanvas.height=h;
      try{
        tctx.drawImage(video,0,0,w,h);
        const img=tctx.getImageData(0,0,w,h).data;
        let sum=0;
        for(let i=0;i<img.length;i+=4) sum+=(img[i]+img[i+1]+img[i+2])/3;
        brightness=Math.round(sum/(img.length/4)*1.2);
      }catch(err){ console.warn(err); }
    }
    requestAnimationFrame(loopFunc);
  }
  loopFunc();
}

function updateBlink(){
  const now=Date.now();
  if(!blinking && now>=nextBlinkAt){ blinking=true; blinkStart=now; }
  if(blinking){
    const elapsed=now-blinkStart, dur=150, p=elapsed/dur;
    if(p>=1){ blinking=false; nextBlinkAt=now+randomInterval(); blinkState=0; }
    else{ blinkState=p<0.5?map(p,0,0.5,0,1):map(p,0.5,1,1,0); }
  }
}

function updatePupil(){
  // ç™½ç›®å†…ã§å°ã•ããƒ©ãƒ³ãƒ€ãƒ ç§»å‹•
  const maxOffset = 5;
  pupilOffsetX += (Math.random()-0.5) * 0.5;
  pupilOffsetY += (Math.random()-0.5) * 0.5;
  pupilOffsetX = Math.max(-maxOffset, Math.min(maxOffset, pupilOffsetX));
  pupilOffsetY = Math.max(-maxOffset, Math.min(maxOffset, pupilOffsetY));
}

function map(v,a,b,c,d){ return c + (d-c)*(v-a)/(b-a); }

function drawMonster(){
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const t1=Number(inputT1.value)||20;
  const t2=Number(inputT2.value)||40;
  const t3=Number(inputT3.value)||80;
  const t4=Number(inputT4.value)||200;

  let level=1;
  if(brightness<=t1) level=1;
  else if(brightness<=t2) level=2;
  else if(brightness<=t3) level=3;
  else level=4;

  // é¡”è‰²ï¼šæš—â†’è–„ã‚°ãƒ¬ãƒ¼ã€æ˜â†’æ·¡é»„è‰²
  const colors=['rgb(200,200,200)','rgb(220,220,180)','rgb(240,240,160)','rgb(255,255,180)'];
  const faceColor = colors[level-1];

  // é¡”
  const faceRadius = 150;
  ctx.beginPath();
  ctx.fillStyle = faceColor;
  ctx.arc(w/2,h/2,faceRadius,0,Math.PI*2);
  ctx.fill();

  // ç›®ï¼šç™½ç›®å›ºå®š
  const eyeY = h/2 - 40, eyeW = 50, eyeH = 30;
  ctx.beginPath(); ctx.fillStyle='white';
  ctx.ellipse(w/2,eyeY,eyeW,eyeH,0,0,Math.PI*2); ctx.fill();

  // ç³å­”ï¼šå††å½¢ã€ç™½ç›®å†…ã§ç§»å‹•
  const minPupil=6, maxPupil=18;
  const pupilR = map(brightness,0,200,maxPupil,minPupil);
  updatePupil();
  ctx.beginPath(); ctx.fillStyle='black';
  ctx.arc(w/2+pupilOffsetX, eyeY+pupilOffsetY, pupilR, 0, Math.PI*2);
  ctx.fill();

  // ç¬ãï¼šç¼ã‚’é¡”è‰²ã§æãï¼ˆé€ã‘ãªã„ï¼‰
  updateBlink();
  if(blinkState>0){
    ctx.beginPath();
    ctx.fillStyle = faceColor;
    const coverH = eyeH*blinkState;
    ctx.ellipse(w/2,eyeY,eyeW,coverH,0,0,Math.PI*2);
    ctx.fill();
  }

  // å£
  const mouthY = h/2 + 60;
  ctx.lineWidth = 4; ctx.strokeStyle='black'; ctx.beginPath();
  if(level===1) ctx.arc(w/2,mouthY+5,50,Math.PI,Math.PI*2);
  else if(level===2){ ctx.moveTo(w/2-50,mouthY); ctx.lineTo(w/2+50,mouthY); }
  else if(level===3) ctx.arc(w/2,mouthY,50,0,Math.PI);
  else ctx.arc(w/2,mouthY-5,60,0,Math.PI);
  ctx.stroke();
}

function loop(){
  drawMonster();
  if(mode==='experiment'){
    brightnessDisplay.style.display='block';
    brightnessDisplay.innerText=`æ˜ã‚‹ã•: ${brightness} lux`;
  } else brightnessDisplay.style.display='none';
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
